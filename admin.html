<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="estiloadmin.css">
  <script src="js/github-api.js"></script>
</head>
<body>
  <div class="admin-header">
    <h2>Panel de Administraci贸n</h2>
    <button id="logout" class="btn-logout">Cerrar Sesi贸n</button>
  </div>
  
  <div class="admin-container">
    <div class="admin-section">
      <h3>Configuraci贸n GitHub</h3>
      <div class="github-config">
        <input type="text" id="githubToken" placeholder="Token de acceso de GitHub" required>
        <input type="text" id="githubUsername" placeholder="Usuario de GitHub" required>
        <input type="text" id="githubRepo" placeholder="Repositorio de GitHub" required>
        <button type="button" onclick="saveGitHubConfig()">Guardar Configuraci贸n</button>
      </div>
    </div>
    
    <div class="admin-section">
      <h3>Agregar Nuevo Proyecto</h3>

  <form id="addProjectForm">
    <input type="text" id="titulo" placeholder="T铆tulo del proyecto" required>
    <input type="text" id="tecnologias" placeholder="Tecnolog铆as usadas" required>

    <!--  Campo Semana -->
    <input type="text" id="semana" placeholder="Semana del proyecto (Ej: Semana 1)" required>

    <!--  Imagen -->
    <label>Imagen del proyecto:</label>
    <input type="file" id="imagen" accept="image/*" required>

    <!--  PDF -->
    <label>Documento PDF del proyecto:</label>
    <input type="file" id="pdf" accept="application/pdf" required>

    <button type="submit">Agregar Proyecto</button>
  </form>

    </div>
    
    <div class="admin-section">
      <h3>Proyectos Existentes</h3>
      <div id="preview"></div>
    </div>
    
    <div class="admin-section">
      <h3>Actividades Recientes</h3>
      <div id="activities-log" class="activities-log">
        <!-- Las actividades se mostrar谩n aqu铆 -->
      </div>
    </div>
  </div>

  <script>
    // Inicializar GitHub Uploader
    const githubUploader = new GitHubUploader();
    
    // Cargar configuraci贸n guardada
    window.onload = function() {
      const savedConfig = localStorage.getItem('githubConfig');
      if (savedConfig) {
        const config = JSON.parse(savedConfig);
        document.getElementById('githubToken').value = config.token || '';
        document.getElementById('githubUsername').value = config.username || '';
        document.getElementById('githubRepo').value = config.repo || '';
        
        // Configurar el uploader
        githubUploader.setConfig(config.token, config.username, config.repo);
      }
      
      // Verificar sesi贸n
      if (!localStorage.getItem("logged")) {
        window.location.href = "index.html";
      }
      
      // Cargar proyectos
      renderProjects();
      renderActivities();
    };
    
    // Guardar configuraci贸n de GitHub
    function saveGitHubConfig() {
      const token = document.getElementById('githubToken').value;
      const username = document.getElementById('githubUsername').value;
      const repo = document.getElementById('githubRepo').value;
      
      if (!token || !username || !repo) {
        alert('Por favor completa todos los campos de configuraci贸n');
        return;
      }
      
      // Guardar en localStorage
      const config = { token, username, repo };
      localStorage.setItem('githubConfig', JSON.stringify(config));
      
      // Configurar el uploader
      githubUploader.setConfig(token, username, repo);
      
      alert('Configuraci贸n guardada correctamente');
    }

    // Cerrar sesi贸n
    document.getElementById("logout").addEventListener("click", () => {
      localStorage.removeItem("logged");
      window.location.href = "index.html";
    });

    // Agregar proyecto
    document.getElementById("addProjectForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const titulo = document.getElementById("titulo").value;
      const tecnologias = document.getElementById("tecnologias").value;
      const semana = document.getElementById("semana").value;
      const pdfFile = document.getElementById("pdf").files[0];
      const imgFile = document.getElementById("imagen").files[0];

      if (!pdfFile || !imgFile) {
        alert("Debes seleccionar una imagen y un PDF.");
        return;
      }

      // Verificar configuraci贸n de GitHub
      const config = JSON.parse(localStorage.getItem('githubConfig') || '{}');
      if (!config.token || !config.username || !config.repo) {
        alert('Por favor configura primero tu cuenta de GitHub');
        return;
      }

      try {
        // Mostrar indicador de carga
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Subiendo a GitHub...';
        submitBtn.disabled = true;

        // Subir imagen a GitHub
        const imageResult = await githubUploader.uploadImage(imgFile, titulo);
        if (!imageResult.success) {
          throw new Error(`Error subiendo imagen: ${imageResult.error}`);
        }

        // Subir PDF a GitHub
        const pdfResult = await githubUploader.uploadPDF(pdfFile, titulo);
        if (!pdfResult.success) {
          throw new Error(`Error subiendo PDF: ${pdfResult.error}`);
        }

        // Crear objeto del proyecto con URLs de GitHub
        const proyectoData = {
          titulo,
          tecnologias,
          semana,
          imagen: imageResult.url,
          pdf: pdfResult.url,
          imagePath: imageResult.path,
          pdfPath: pdfResult.path,
          fechaCreacion: new Date().toISOString(),
          almacenadoEnGitHub: true
        };

        // Guardar datos del proyecto en GitHub
        const dataResult = await githubUploader.saveProjectData(proyectoData);
        if (!dataResult.success) {
          throw new Error(`Error guardando datos: ${dataResult.error}`);
        }

        // Tambi茅n guardar en localStorage como respaldo
        let proyectos = JSON.parse(localStorage.getItem("proyectos")) || [];
        proyectos.push(proyectoData);
        localStorage.setItem("proyectos", JSON.stringify(proyectos));

        // Registrar actividad
        logActivity(`Proyecto "${titulo}" guardado completamente en GitHub`);
        
        renderProjects();
        document.getElementById("addProjectForm").reset();
        
        alert(`隆Proyecto guardado exitosamente en GitHub!\n\n Imagen: ${imageResult.path}\n PDF: ${pdfResult.path}\n Datos: projects.json`);
        
      } catch (error) {
        console.error('Error:', error);
        alert(`Error al subir el proyecto: ${error.message}`);
      } finally {
        // Restaurar bot贸n
        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    });

    // Renderizar proyectos (cargar desde GitHub y localStorage)
    async function renderProjects() {
      const preview = document.getElementById("preview");
      preview.innerHTML = "<p>Cargando proyectos...</p>";

      try {
        // Intentar cargar desde GitHub primero
        const config = JSON.parse(localStorage.getItem('githubConfig') || '{}');
        let proyectos = [];
        
        if (config.token && config.username && config.repo) {
          githubUploader.setConfig(config.token, config.username, config.repo);
          proyectos = await githubUploader.getProjects();
        }
        
        // Si no hay proyectos en GitHub, cargar del localStorage
        if (proyectos.length === 0) {
          proyectos = JSON.parse(localStorage.getItem("proyectos")) || [];
        }

        preview.innerHTML = "";

        if (proyectos.length === 0) {
          preview.innerHTML = "<p>No hay proyectos a煤n.</p>";
          return;
        }

        proyectos.forEach((p, index) => {
          const card = document.createElement("div");
          card.classList.add("card");

          const githubIndicator = p.almacenadoEnGitHub ? 
            '<span style="color: #27ae60;"> GitHub</span>' : 
            '<span style="color: #e67e22;"> Local</span>';

          card.innerHTML = `
            <h3>${p.titulo} ${githubIndicator}</h3>
            <p>${p.tecnologias}</p>
            <p><strong>${p.semana}</strong></p>
            <img src="${p.imagen}" alt="Imagen del proyecto" style="max-width:200px; display:block; margin:10px 0;">
            <a href="${p.pdf}" target="_blank"> Ver PDF</a><br>
            <a href="${p.pdf}" download="${p.titulo}.pdf">猬锔 Descargar PDF</a><br>
            ${p.almacenadoEnGitHub ? `<small> ${p.imagePath}</small><br><small> ${p.pdfPath}</small><br>` : ''}
            <button class="edit" onclick="editProject(${index})">Editar</button>
            <button class="delete" onclick="deleteProject(${index})">Eliminar</button>
          `;

          preview.appendChild(card);
        });
        
      } catch (error) {
        console.error('Error cargando proyectos:', error);
        preview.innerHTML = "<p>Error al cargar los proyectos.</p>";
      }
    }

    // Eliminar proyecto
    async function deleteProject(index) {
      if (!confirm('驴Est谩s seguro de que quieres eliminar este proyecto? Esta acci贸n eliminar谩 los archivos de GitHub.')) {
        return;
      }
      
      try {
        // Cargar proyectos desde GitHub
        const config = JSON.parse(localStorage.getItem('githubConfig') || '{}');
        let proyectos = [];
        
        if (config.token && config.username && config.repo) {
          githubUploader.setConfig(config.token, config.username, config.repo);
          proyectos = await githubUploader.getProjects();
        }
        
        // Si no hay en GitHub, cargar del localStorage
        if (proyectos.length === 0) {
          proyectos = JSON.parse(localStorage.getItem("proyectos")) || [];
        }
        
        const proyecto = proyectos[index];
        
        // Si est谩 en GitHub, eliminar de all铆
        if (proyecto.almacenadoEnGitHub) {
          const results = await githubUploader.deleteProject(proyecto);
          
          // Verificar resultados
          const failed = results.filter(r => !r.success);
          if (failed.length > 0) {
            console.error('Errores eliminando de GitHub:', failed);
            alert('Algunos archivos no pudieron eliminarse de GitHub, pero el proyecto fue eliminado localmente.');
          } else {
            logActivity(`Proyecto "${proyecto.titulo}" eliminado completamente de GitHub`);
          }
        } else {
          // Eliminar solo del localStorage
          logActivity(`Proyecto "${proyecto.titulo}" eliminado del almacenamiento local`);
        }
        
        // Eliminar del localStorage
        proyectos.splice(index, 1);
        localStorage.setItem("proyectos", JSON.stringify(proyectos));
        
        // Registrar actividad
        logActivity(`Proyecto "${proyecto.titulo}" eliminado`);
        
        renderProjects();
        
      } catch (error) {
        console.error('Error eliminando proyecto:', error);
        alert(`Error al eliminar el proyecto: ${error.message}`);
      }
    }

    // Editar proyecto (b谩sico)
    function editProject(index) {
      let proyectos = JSON.parse(localStorage.getItem("proyectos")) || [];
      const p = proyectos[index];

      document.getElementById("titulo").value = p.titulo;
      document.getElementById("tecnologias").value = p.tecnologias;
      document.getElementById("semana").value = p.semana;

      // 锔 El PDF y la Imagen no se pueden volver a cargar autom谩ticamente en los input type=file
      deleteProject(index);
    }

    // Cargar al inicio
    // renderProjects(); // Ya se carga en window.onload
    
    // Funci贸n para registrar actividad
    function logActivity(activity) {
      const activities = JSON.parse(localStorage.getItem('activities') || '[]');
      const timestamp = new Date().toLocaleString();
      activities.unshift({ activity, timestamp });
      
      // Mantener solo las 煤ltimas 50 actividades
      if (activities.length > 50) {
        activities.length = 50;
      }
      
      localStorage.setItem('activities', JSON.stringify(activities));
      renderActivities();
    }
    
    // Funci贸n para mostrar actividades
    function renderActivities() {
      const activities = JSON.parse(localStorage.getItem('activities') || '[]');
      const activitiesLog = document.getElementById('activities-log');
      
      if (activities.length === 0) {
        activitiesLog.innerHTML = '<p>No hay actividades recientes.</p>';
        return;
      }
      
      activitiesLog.innerHTML = activities.map(act => `
        <div class="activity-item">
          <i class="fas fa-circle activity-dot"></i>
          <div class="activity-content">
            <span class="activity-text">${act.activity}</span>
            <span class="activity-time">${act.timestamp}</span>
          </div>
        </div>
      `).join('');
    }
  </script>
</body>
</html>
